<body>
    <!-- Add icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" type="text/css" href="styles.css">

    <script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <script src="https://component.kitchen/polyfills/webcomponents-lite.js"></script>

    <!--    Modal    -->
    <div id="newItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close">&times;</span>
                <h2>Add Item</h2>
            </div>
            <div class="modal-body">
                <input class="modalTitle" type="text" placeholder="Title..." id="titleModalInput">
                <input class="modalDescription" type="text" placeholder="Description..." id="descriptionModalInput">
                <div class="dropdown">
                    <select id="columnSelect"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn danger" onclick="modal.closeModal()">Cancel</button>
                <button class="btn success" onclick="modal.addItem()">Confirm</button>
            </div>
        </div>    
    </div>

    <!--    Topnav    -->
    <div class="topnav">
        <a class="active">Trello-like</a>
        <b class="btn-group">            
            <button onclick="topnav.addColumn()" class="btn success"><span class="fa fa-plus"></span> Add Column</button>
            <button onclick="topnav.addCard()" class="btn success"><span class="fa fa-plus"></span> Add Card</button>
        </b>
        <c>
            <button onclick="topnav.filterCards()" class="btn success"><span class="fa fa-search"></span></button>
            <input type="text" placeholder="Search..." id="searchInput">
        </c>
    </div>

    <div id="rawColumns"></div>

    <div id="rawCards"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <!-- <script src="js/scripts.js"></script> -->
</body>

<script>
    //TopNav Elements    
    var searchInput = document.getElementById("searchInput");

    // Modal Elements
    var modal = document.getElementById('newItemModal');
    var titleModalInput = document.getElementById('titleModalInput');
    var descriptionModalInput = document.getElementById('descriptionModalInput');
    var columnSelect = document.getElementById('columnSelect');
    var closeButton = document.getElementsByClassName("close")[0];

    // Main Page Elements
    var rawColumns = document.getElementById('rawColumns');
    var rawCards = document.getElementById('rawCards');

    var maltem = {};

    // Read Data from JSON
    $.getJSON("db.json", function(json) {
        maltem.columns = json.columns;
        maltem.cards = json.cards;
        maltem.updateRawColumns();
        maltem.updateRawCards();
    });

    // Common Functions
    maltem.updateRawColumns = function(){
        while (rawColumns.firstChild) {
            rawColumns.removeChild(rawColumns.firstChild);
        }
        $.each(maltem.columns, function(){
            $("<a></a>")
            .attr("value", this.id)
            .html(this.title)
            .appendTo("#rawColumns");
        });
    }
    maltem.updateRawCards = function(){
        while (rawCards.firstChild) {
            rawCards.removeChild(rawCards.firstChild);
        }
        $.each(maltem.cards, function(){
            $("<a></a>")
            .attr("value", this.id)
            .html(this.title)
            .appendTo("#rawCards");
        });
    }
    maltem.refreshColumnSelect = function(){
        while (columnSelect.firstChild) {
            columnSelect.removeChild(columnSelect.firstChild);
        }
        $.each(maltem.columns, function(){
            $("<option></option>")
            .attr("value", this.id)
            .html(this.title)
            .appendTo("#columnSelect");
        });
    }

    // Common Modal Functions
    modal.addItem = function() {
        var newItem = {
            id: new Date().getUTCMilliseconds(), //timestamp Id
            title: titleModalInput.value
        }

        if(modal.mode === "COLUMN" && modal.checkIfUnique(newItem,"COLUMN") == true){
            maltem.columns.push(newItem);
            console.log(maltem.columns);

        } else if(modal.mode === "CARD" && modal.checkIfUnique(newItem,"CARD") == true) {
            newItem.description = descriptionModalInput.value;
            newItem.columnId = columnSelect.value;

            maltem.cards.push(newItem);

            console.log(maltem.cards);
        } else {
            window.alert("Title is not unique !");
            return;
        }

        // Reset Modal
        titleModalInput.value = null;
        descriptionModalInput.value = null;
        columnSelect.value = null;


        modal.closeModal();
    }
    modal.checkIfUnique = function(newItem, objectType){        
        var unique = true;
        var array = [];

        if(objectType.localeCompare("COLUMN") == 0) {
            array = maltem.columns;
        } else if(objectType.localeCompare("CARD" == 0)){
            array = maltem.cards;
        }
        
        array.some(function(element){
            if(element.title.localeCompare(newItem.title) == 0) {
                unique = false;
            }
        });

        return unique;
    }

    modal.closeModal = function(){
        maltem.updateRawColumns();
        maltem.updateRawCards();
        modal.style.display = "none";
    }
    closeButton.onclick = function(event){
        modal.closeModal();
    }

    // TopNav Functions
    var topnav = {};
    topnav.addColumn = function() {
        modal.mode = "COLUMN";
        descriptionModalInput.style.display = "none";
        columnSelect.style.display = "none";
        modal.style.display = "block";
    };
    topnav.addCard = function() {
        maltem.refreshColumnSelect();
        modal.mode = "CARD";
        descriptionModalInput.style.display = "inline-block";
        columnSelect.style.display = "inline-block";
        modal.style.display = "block";
    };
    topnav.filterCards = function() {
    }

    // Column Functions
    var columnElement = {};
    columnElement.editColumn = function(columnId, editedColumn){
        var replacements = [editedColumn];
        maltem.columns.map(obj => replacements.find(o => o.id === obj.id) || obj);
    }
    columnElement.deleteColumn = function(columnId) {
        if (maltem.columns.length > 1) {
            var removed = maltem.pop('columns');
        }
    };
    
    // Card Functions
    var cardElement = {};
    cardElement.editCard = function(cardId, editedCard){
        var replacements = [editedCard];
        maltem.cards.map(obj => replacements.find(o => o.id === obj.id) || obj);
    }
    cardElement.deleteCard = function(cardId) {
        if (maltem.cards.length > 1) {
            var removed = maltem.pop('cards');
        }
    };

</script>